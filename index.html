<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
    // IHR PUBLIC KEY
    emailjs.init("R-lWfM9BhbTaTWskW"); 
</script>
<script>
/* Beispielprofile */
const opas = [
{
id: 'opa1', name: 'Karl', age: 78, skills: ['Geschichten', 'Handwerk', 'Angeln'], location: 'Berlin', price: '50€ /Stunde', img: 'https://www.karneval-universe.de/out/pictures/master/product/2/grossvater-maske-mit-haaren--opa-maske-mit-haaren--alter-mann-maske--grandpa-mask--37862-02.jpg'
},
{
id: 'opa2', name: 'Friedrich', age: 82, skills: ['Vorlesen', 'Karten', 'Kaffee & Gespräch'], location: 'Hamburg', price: '45€ /Stunde', img: 'https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=6a3f5a8b4d4c2b1a0f1e2d3c4b5a6d7e'
},
{
id: 'opa3', name: 'Emil', age: 74, skills: ['Garten', 'Spaziergänge', 'Kleintechnik'], location: 'München', price: '55€ /Stunde', img: 'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=f4f1a2a3b2c3d4e5f6a7b8c9d0e1f2a3'
},
{
id: 'opa4', name: 'Hans', age: 79, skills: ['Schach', 'Geschichte', 'Museumsbesuche'], location: 'Köln', price: '60€ /Stunde', img: 'https://i.mmo.cm/is/image/mmoimg/thumbnew/opa-deluxe-maske-aus-latex--107189-3.jpg'
},
{
id: 'opa5', name: 'Walter', age: 85, skills: ['Lebenserfahrung', 'Kochen', 'Musik'], location: 'Frankfurt', price: '65€ /Stunde', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoLjkH60zxUnD2_LyrB-DRpW892lr25NE05g&s'
},
{
id: 'opa6', name: 'Günther', age: 76, skills: ['Heimwerken', 'Technik-Hilfe', 'Humor'], location: 'Stuttgart', price: '70€ /Stunde', img: 'https://img.fotocommunity.com/opa-36559145-12bb-4582-9776-722418cb9ea3.jpg?width=1000'
},
{
id: 'opa7', name: 'Jürgen', age: 81, skills: ['Naturkunde', 'Wandern', 'Fotografie'], location: 'Düsseldorf', price: '50€ /Stunde', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqDcHb93Hlz1h08eiAE-tf1HOwFfou8KNXjA&s'
},
{
id: 'opa8', name: 'Klaus', age: 77, skills: ['Autos', 'Sport', 'Grillen'], location: 'Dortmund', price: '40€ /Stunde', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSo2X35wlFu8W8JKW3fqaij2Zcy5hL6-PmdLQ&s'
},
{
id: 'opa9', name: 'Helmut', age: 72, skills: ['Modelleisenbahn', 'Geschichte', 'Computer-Hilfe'], location: 'Leipzig', price: '50€ /Stunde', img: 'https://i.mmo.cm/is/image/mmoimg/mw-product-max/opa-maske-aus-latex--mw-107196-1.jpg'
},
{
id: 'opa10', name: 'Wolfgang', age: 80, skills: ['Klassische Musik', 'Reisen', 'Französisch'], location: 'Dresden', price: '55€ /Stunde', img: 'https://www1.wdr.de/dossiers/kindheit-im-krieg/kk-norbert-engelhardt-teaser-100~_v-HDready.jpg'
},
{
id: 'opa11', name: 'Hermann', age: 75, skills: ['Tiere', 'Basteln', 'Spaziergänge'], location: 'Hannover', price: '48€ /Stunde', img: 'https://bilder.krause-sohn.de/item/images/14761/secondPreview/14761-Opa-Peruecke-Heinz-mit-Brille-grauem-Bart-und-Augenbrauen-fuer-Herren.jpg'
},
{
id: 'opa12', name: 'Gerd', age: 83, skills: ['Briefmarken', 'Vorlesen', 'Kochen'], location: 'Nürnberg', price: '62€ /Stunde', img: 'https://www.fasching365.de/media/catalog/product/cache/7/image/040ec09b1e35df139433887a97daa66f/w/d/wdm1516-00499_a_8.jpg'
},
{
id: 'opa13', name: 'Manfred', age: 70, skills: ['Wanderführer', 'Holzarbeiten', 'Geografie'], location: 'Freiburg', price: '52€ /Stunde', img: 'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8b2xkJTIwbWFufGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=60'
},
{
id: 'opa14', name: 'Erich', age: 73, skills: ['Gedichte', 'Angeln', 'Kochen'], location: 'Bremen', price: '58€ /Stunde', img: 'https://cdn.prod.www.spiegel.de/images/0ec694e8-926b-44ae-8ca3-3a4873c411a8_w960_r1.778_fpx54_fpy47.jpg'
},
{
id: 'opa15', name: 'Theodor', age: 71, skills: ['Malen', 'Vogelkunde', 'Gespräche'], location: 'Würzburg', price: '53€ /Stunde', img: 'https://img.fotocommunity.com/ein-netter-opa-d47f529c-2761-43ff-a840-25fc566c90b3.jpg?height=1080'
},
{
id: 'opa16', name: 'Michael Steinbock', age: 78, skills: ['Modelleisenbahn', 'Handwerk', 'Geschichten'], location: 'Kassel', price: '60€ /Stunde', img: 'https://i.imgur.com/C8iX5kS.jpeg'
}
];

/* --- NEUE FUNKTIONEN: Zähler und Verfügbarkeit --- */

// Maximale Buchungen für die Demo, bevor der Opa als ausgebucht gilt
const MAX_BOOKINGS = 3;

/**
 * Zählt die aktuellen Buchungen pro Opa aus dem LocalStorage.
 * @returns {Object.<string, number>} Ein Objekt { opaId: anzahlBuchungen }
 */
function countOpaBookings() {
    const allBookings = JSON.parse(localStorage.getItem('rent-a-opa-bookings') || '[]');
    const counts = {};
    opas.forEach(opa => counts[opa.id] = 0); // Initialisiere alle Zähler mit 0
    
    allBookings.forEach(booking => {
        // Die Buchungsdatenbank muss nun die 'opaId' speichern (wird in der submit-Logik unten gemacht)
        const opaId = booking.opaId;
        if (opaId && counts[opaId] !== undefined) {
            counts[opaId]++;
        }
    });
    return counts;
}

let bookingCounts = countOpaBookings();
console.info('Aktuelle Buchungsanzahl pro Opa:', bookingCounts);


/* Render Cards (mit Verfügbarkeits-Logik) */
const grid = document.getElementById('grid');

function createCard(o){
    const currentBookings = bookingCounts[o.id] || 0;
    const isAvailable = currentBookings < MAX_BOOKINGS;

    const el = document.createElement('article');
    el.className='card';
    
    let bookingHtml = '';
    let bookingClass = '';

    if (isAvailable) {
        bookingHtml = `
            <div style="font-weight:700; color:#0d9488; font-size:13px;">✅ ${currentBookings} Buchungen</div>
            <button class="book" data-id="${o.id}">Buchen</button>
        `;
        bookingClass = '';
    } else {
        bookingHtml = `
            <div style="font-weight:700; color:red; font-size:13px;">❌ NICHT VERFÜGBAR</div>
            <button class="book" data-id="${o.id}" disabled style="cursor:not-allowed; opacity:0.6;">Ausgebucht</button>
        `;
        // Wenn ausgebucht, fügen wir eine visuelle Klasse hinzu
        bookingClass = 'style="opacity:0.6; filter:grayscale(50%);"'; 
    }

    el.innerHTML = `
        <img src="${o.img}" alt="Porträt von ${o.name}" loading="lazy" ${bookingClass} />
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <div style="font-weight:800">${o.name}, ${o.age}</div>
                <div class="small">${o.location}</div>
            </div>
            <div style="text-align:right">
                <div class="small">Preis</div>
                <div style="font-weight:700">${o.price}</div>
            </div>
        </div>
        <div class="tags small">${o.skills.join(' · ')}</div>
        <div style="display:flex;gap:8px;margin-top:8px; align-items:center;">
            ${bookingHtml}
            <button class="small" style="background:transparent;border:0;color:var(--muted);cursor:pointer" data-id="info-${o.id}">Profil ansehen</button>
        </div>
    `;
    return el;
}

/**
 * Rendert die Opa-Karten neu
 */
function renderOpas() {
    grid.innerHTML = ''; 
    bookingCounts = countOpaBookings(); // Zähler aktualisieren
    opas.forEach(o => grid.appendChild(createCard(o)));
}

// Initiales Rendering
renderOpas();


/* Modal and booking logic (Angepasst für Verfügbarkeit) */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const summary = document.getElementById('profile-summary');
let selectedOpa = null;

function openModal(opa){
    // Überprüfung der Verfügbarkeit vor dem Öffnen des Modals
    const currentBookings = bookingCounts[opa.id] || 0;
    if (currentBookings >= MAX_BOOKINGS) {
        alert(`${opa.name} ist momentan mit ${currentBookings} Buchungen ausgebucht!`);
        return; // Modal nicht öffnen
    }
    
    selectedOpa = opa;
    modalTitle.textContent = `Buchungsanfrage — ${opa.name}`;
    summary.textContent = `${opa.name}, ${opa.age} • ${opa.location} • ${opa.skills.join(', ')}`;
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
    document.getElementById('name').focus();
}

function closeModal(){
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
    selectedOpa = null;
    document.getElementById('booking-form').reset();
}

/* Event delegation for book buttons */
grid.addEventListener('click', (e)=>{
    const b = e.target.closest('button');
    if(!b || b.disabled) return; // Wenn Button disabled ist, nichts tun
    
    const id = b.getAttribute('data-id');
    if(!id) return;
    
    const ida = id.replace('info-','');
    const opa = opas.find(x=>x.id===ida);
    if(!opa) return;

    // Nur bei Klick auf "Buchen" das Modal öffnen
    if (b.textContent.includes('Buchen')) {
        openModal(opa);
    }
});

/* close handlers */
document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal-cancel').addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });


/* LOGIK FÜR DEN EMAILJS VERSAND (mit Zähler-Update und Neu-Rendering) */
document.getElementById('booking-form').addEventListener('submit', (e) => {
    e.preventDefault();
    if (!selectedOpa) return alert('Kein Opa ausgewählt.');

    const form = e.target;
    const data = {
        opaName: selectedOpa.name,
        opaId: selectedOpa.id, // Wichtig für die Zählung!
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        date: form.date.value,
        purpose: form.purpose.value,
        message: form.msg.value.trim()
    };

    // Überprüfung der Verfügbarkeit direkt vor dem Senden
    if ((bookingCounts[data.opaId] || 0) >= MAX_BOOKINGS) {
        alert(`${data.opaName} wurde gerade ausgebucht! Die Liste wird aktualisiert.`);
        closeModal();
        renderOpas();
        return;
    }
    
    // Einfache Validierung
    if (!data.name || !data.email || !data.date || !data.purpose) {
        return alert('Bitte fülle alle Pflichtfelder aus.');
    }

    // Daten für die EmailJS-Vorlage vorbereiten 
    const templateParams = {
        // IHRE EMPFÄNGER-E-MAIL
        to_email: 'Samuel@mxweiss.de', 
        from_name: data.name,
        from_email: data.email,
        opa_name: data.opaName,
        booking_date: new Date(data.date).toLocaleString('de-DE', { timeZone: 'Europe/Berlin' }), 
        booking_purpose: data.purpose,
        user_message: data.message
    };
    
    const submitButton = form.querySelector('.book');
    submitButton.textContent = 'Sende...';
    submitButton.disabled = true;

    // E-Mail senden mit Ihren EmailJS-IDs
    // IHRE SERVICE ID und TEMPLATE ID
    emailjs.send('service_tgg88pq', 'template_cfcflgu', templateParams)
        .then((response) => {
            console.log('E-Mail erfolgreich gesendet!', response.status, response.text);
            alert(`Deine Anfrage für ${data.opaName} wurde erfolgreich abgesendet.`);
            
            // --- WICHTIG: Lokale Speicherung und Zähler aktualisieren ---
            const existing = JSON.parse(localStorage.getItem('rent-a-opa-bookings') || '[]');
            existing.push({...data, id: 'bk_' + Date.now()});
            localStorage.setItem('rent-a-opa-bookings', JSON.stringify(existing));
            
            // UI neu rendern, um den neuen Zählerstand und ggf. "Ausgebucht" anzuzeigen
            renderOpas(); 

            closeModal();
        }, (error) => {
            console.error('E-Mail Senden fehlgeschlagen:', error);
            alert('Fehler beim Senden der Anfrage. Bitte prüfen Sie die Konsolenmeldung (F12).');
        })
        .finally(() => {
            // Button wiederherstellen
            submitButton.textContent = 'Anfrage absenden';
            submitButton.disabled = false;
        });
});

console.info('Demo-Opas geladen. (Buchungs-Limit: ' + MAX_BOOKINGS + ' pro Opa)');
</script>
